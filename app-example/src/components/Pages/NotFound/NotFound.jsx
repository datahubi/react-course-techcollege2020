import React, { useState, useEffect, useCallback, useRef } from "react";
import { NavLink } from "react-router-dom";
import CanvasDraw from "react-canvas-draw";
import { SketchPicker } from "react-color";
import styled from "styled-components";

import { useSessionStorageMem } from "../../../hooks/useStorageLib";
import {
  SettingsBackupRestore,
  Shuffle,
  Palette,
  InvertColors,
  InvertColorsOff,
  Clear
} from "styled-icons/material";
import styles from "./NotFound.module.scss";

const makeIcon = icon => {
  return styled(icon);
};
const makeDefaultIcon = icon => {
  return makeIcon(icon)``;
};

// const defaultDrawing =
//   '{"lines":[{"points":[{"x":45.93718968938989,"y":56.46051991402656},{"x":46.591169495435516,"y":55.62726856467545},{"x":47.472579251075544,"y":54.53297681333925},{"x":47.91156443478877,"y":54.05187872089331},{"x":48.86892432398021,"y":53.01278233830733},{"x":49.83093675800745,"y":51.9776311564917},{"x":50.33761046282536,"y":51.491896877934444},{"x":51.35610094921146,"y":50.511141582851636},{"x":52.37267855815265,"y":49.528322785495504},{"x":52.93039961429496,"y":49.045129976247225},{"x":53.98983228345463,"y":48.11320991897404},{"x":55.04344259690495,"y":47.173743139615986},{"x":56.09175306394002,"y":46.227595554542745},{"x":56.68186778099434,"y":45.748744074167206},{"x":57.1634253716457,"y":45.306302179972434},{"x":57.745196544872655,"y":44.826126382207924},{"x":58.22771967994345,"y":44.37572923386666},{"x":58.80205217136145,"y":43.8944939497604},{"x":59.28532751320799,"y":43.43701413405362},{"x":59.85303192542856,"y":42.95493040154019}],"brushColor":"#302a89","brushRadius":10},{"points":[{"x":131.1711878785496,"y":39.975656157775305},{"x":131.59101418951403,"y":40.21648548007949},{"x":132.760161379113,"y":40.9308471393891},{"x":133.91854260828097,"y":41.6787200176259},{"x":135.0658025999438,"y":42.45610177847749},{"x":136.2019367309448,"y":43.25944427161622},{"x":136.67133447787623,"y":43.63925519896584},{"x":137.15271814493872,"y":44.080367105005415},{"x":138.19009194735665,"y":45.039769021134184},{"x":138.67581837527925,"y":45.5441210149814},{"x":139.65869502528255,"y":46.56064476076281},{"x":140.64340452147485,"y":47.575455410688306},{"x":141.62974818104797,"y":48.58872773372092},{"x":142.11325802850885,"y":49.14320339522635},{"x":142.58960089723206,"y":49.6279914316206},{"x":143.07351083950246,"y":50.17801779576013},{"x":144.01306379906185,"y":51.23156062313151}],"brushColor":"#411890","brushRadius":10},{"points":[{"x":34.4656575004148,"y":149.1965382749211},{"x":36.00000267576442,"y":149.19551363456497},{"x":37.03591241049297,"y":149.1151896844332},{"x":38.29476909783543,"y":148.830901128662},{"x":40.402797904113136,"y":148.27050235925262},{"x":42.50697869336781,"y":147.6386536107943},{"x":44.00141561065896,"y":146.9865771436333},{"x":46.04113363704161,"y":146.07659480771432},{"x":47.234541581210756,"y":145.48890594873848},{"x":49.23959383573575,"y":144.49915314945017},{"x":50.42652305458717,"y":143.86214406679602},{"x":51.60485483856902,"y":143.18257773700876},{"x":53.54932095549806,"y":142.08523749066606},{"x":54.7209244057501,"y":141.37947908004347},{"x":56.64538094401523,"y":140.25230537242845},{"x":57.81120365663103,"y":139.52693444428218},{"x":58.96610352092429,"y":138.769363068098},{"x":60.847095193158474,"y":137.58425886548915},{"x":61.999487337759085,"y":136.8199766484594},{"x":63.14071926057081,"y":136.02815664253956},{"x":64.27093199326197,"y":135.21211641089863},{"x":64.96041959294432,"y":134.76068988393487},{"x":66.10458839629025,"y":133.975786174961},{"x":67.23767781559789,"y":133.16582827888817},{"x":67.93133816864274,"y":132.71605641974313},{"x":69.07766000689483,"y":131.9363642793603},{"x":70.21286816776214,"y":131.1309897924888},{"x":71.33722434612855,"y":130.3030299636042},{"x":72.01842742698265,"y":129.8484465520741},{"x":72.73988288802103,"y":129.4108428997988},{"x":73.1877907230987,"y":129.09550615997787},{"x":73.88773220503256,"y":128.6483080023217},{"x":74.62598969498144,"y":128.21907609513207},{"x":75.06676371124477,"y":127.92031641155886},{"x":75.78204920007407,"y":127.47983513493148},{"x":76.53402011608414,"y":127.05804214442487},{"x":76.96841128223465,"y":126.77287985218796},{"x":77.69627622284618,"y":126.33837606151472},{"x":78.45946024477786,"y":125.92309252985963},{"x":78.88823633129682,"y":125.64909697816991},{"x":79.62642867752342,"y":125.21983106000422},{"x":80.3987988182976,"y":124.81018027768536},{"x":81.57853797642419,"y":124.13671249336137},{"x":82.35723499496599,"y":123.73110469799423},{"x":83.1654682053659,"y":123.34627124818135},{"x":84.35517157289846,"y":122.727141482765},{"x":85.16368249076999,"y":122.34251918901909},{"x":86.3534477521732,"y":121.72382777518581},{"x":88.0072170522396,"y":120.99985109519538},{"x":88.8631658202323,"y":120.65638402762454},{"x":90.05940877971317,"y":120.11735433360688},{"x":90.90816519958659,"y":119.76693236224078},{"x":91.77783824068968,"y":119.43756887566225},{"x":92.97418282611076,"y":118.92367521297187},{"x":93.8346978904655,"y":118.58477515659693},{"x":94.71461304147252,"y":118.26672066040781},{"x":95.61138403069172,"y":117.96895822449706},{"x":96.80488818262603,"y":117.50831837115302},{"x":97.6889743305721,"y":117.19508010594211},{"x":99.50948107461507,"y":116.6469760911691},{"x":100.43537385456618,"y":116.39053326806771},{"x":103.47047509411529,"y":115.5146692840287},{"x":106.3027717464997,"y":114.86609126884157},{"x":109.35908885905862,"y":114.10112108186821},{"x":111.26471126395217,"y":113.69409096814555},{"x":112.22589215053439,"y":113.5049089732182},{"x":113.19272319185141,"y":113.3295117590145},{"x":115.14184852806967,"y":113.0271313948062},{"x":116.12096235873398,"y":112.88704838630291},{"x":117.10313929142075,"y":112.75743798624761},{"x":118.08793344512439,"y":112.63755875474553},{"x":119.07496292840311,"y":112.52671276914458},{"x":120.06390090743636,"y":112.42424510409441},{"x":121.05446785117884,"y":112.32954276692264},{"x":122.04642481819651,"y":112.24203324886979},{"x":123.03956765949589,"y":112.16118281705245},{"x":124.03372202265511,"y":112.0864946434272},{"x":125.0003640739804,"y":112.0940246397178},{"x":126.00031021752316,"y":112.10121486616433},{"x":126.04886969006131,"y":112.1056107658985},{"x":127.04165199034752,"y":112.18854410505747},{"x":127.1642208888802,"y":112.20903270616364},{"x":128.14005835087852,"y":112.35944527449706},{"x":128.32727061648657,"y":112.40408685437062},{"x":129.27937680076727,"y":112.61320556819793},{"x":129.52186514729308,"y":112.68715425949455},{"x":130.4459880967981,"y":112.94638770008375},{"x":130.7349475146665,"y":113.05245556218787},{"x":131.6288542344212,"y":113.35382761207227},{"x":131.95635604459326,"y":113.493042823051},{"x":132.8193397872928,"y":113.82942276250341},{"x":133.17846322485482,"y":114.00152450601814},{"x":134.0109145585451,"y":114.36671156236828},{"x":135.20502410714036,"y":114.94646045878498},{"x":136.3932960355331,"y":115.57520715213808},{"x":137.57330936430859,"y":116.2474560281438},{"x":138.01049837148878,"y":116.53845065336618},{"x":139.15089353123727,"y":117.33220264926632},{"x":140.28028932993385,"y":118.14994186594512},{"x":141.39904360223383,"y":118.98877537349892},{"x":142.50764658186654,"y":119.8461631608916},{"x":142.98581955176712,"y":120.26635419609664},{"x":143.5883649638044,"y":120.74296334917642},{"x":144.68010051310597,"y":121.62843434648222},{"x":145.16162919117667,"y":122.07065323258227},{"x":145.7436088024131,"y":122.55079770141353},{"x":146.82095154489443,"y":123.45800651990547},{"x":147.30445342699096,"y":123.91782831385486},{"x":147.86996504529031,"y":124.40017300508197},{"x":148.93525870972445,"y":125.32426495706927},{"x":149.41988800974443,"y":125.79812110554823},{"x":149.972247083357,"y":126.28182626046056},{"x":151.0275860483903,"y":127.2190755709827},{"x":151.51283195489836,"y":127.70410571621208},{"x":152.05470360667286,"y":128.18864555479794},{"x":153.101895212086,"y":129.13618140095664},{"x":154.144377325307,"y":130.08947881927546},{"x":155.18259201949076,"y":131.0478859732017},{"x":156.2169460065058,"y":132.01082814970752},{"x":157.24781201704005,"y":132.97779808635346},{"x":157.81982880715557,"y":133.45934000747465},{"x":158.3033175552037,"y":133.91902284550704},{"x":158.8689592938102,"y":134.4013523246791},{"x":159.35298490476754,"y":134.86709556615054},{"x":159.91294970895567,"y":135.35005673015547},{"x":160.9740809537735,"y":136.2797325925097},{"x":161.57801105899415,"y":136.75607184684105},{"x":162.05768319078922,"y":137.18531466824803},{"x":162.6517829788497,"y":137.66348255414863},{"x":163.29429326367165,"y":138.1306411556989}],"brushColor":"#5f062e","brushRadius":10}],"width":"400","height":400}';

const defaultDrawing =
  '{"lines":[{"points":[{"x":62.596001388308736,"y":35.5605974037207},{"x":61.9924751403539,"y":36.23650334427362},{"x":60.21499948072357,"y":38.59876794131994},{"x":58.08798946271737,"y":41.504504318063155},{"x":56.10619703882588,"y":44.85723583478941},{"x":54.99197662186215,"y":46.790566982852226},{"x":53.55221043123781,"y":49.54922197546736},{"x":51.90257914637495,"y":53.23465937696848},{"x":50.67531324972733,"y":56.13573787729196},{"x":49.78516295373091,"y":58.18285482142921},{"x":48.58155184989015,"y":61.096540499272926},{"x":47.41923743320846,"y":64.03087235052952},{"x":45.20515365713862,"y":69.94843052250971},{"x":43.28329937755103,"y":74.97797965155195},{"x":41.93761406051171,"y":78.85192787017522},{"x":40.471999261515286,"y":83.7007588987112},{"x":39.24028493462198,"y":86.961637731416},{"x":36.649749982277925,"y":93.12495847003021},{"x":34.84643440599362,"y":97.2097008786642},{"x":32.98877991585762,"y":101.2736521473343},{"x":31.386195079447955,"y":104.4642121382418},{"x":29.38086684979297,"y":108.46153748166165},{"x":28.37862079100869,"y":110.46041100127677},{"x":27.018730428755653,"y":112.80603170182701},{"x":25.917787829851804,"y":114.74816155348636},{"x":24.832252821368087,"y":116.70013488631945},{"x":23.026132285534576,"y":119.8103265082809},{"x":22.30530039200504,"y":120.97754471280207},{"x":21.50605109878763,"y":122.52525814860967},{"x":20.846264928270998,"y":123.70793958992228},{"x":19.771699102697927,"y":125.66668779428528},{"x":19.080739263705944,"y":126.84223006602414},{"x":18.353498412469147,"y":128.00746768557428},{"x":17.928964569900117,"y":128.7545052655592},{"x":22.237748780965532,"y":130.87958621976665},{"x":31.250255162219105,"y":132.74957132035388},{"x":38.003271821916044,"y":132.9072982491732},{"x":43.010746288055216,"y":132.69523559124625},{"x":54.00292561971587,"y":132.45246474091866},{"x":56.00214949371619,"y":132.41461941542985},{"x":60.001209124057205,"y":132.35784528285777},{"x":62.00088834608914,"y":132.3335120439573},{"x":65.00056854738953,"y":132.30431101875553},{"x":67.00041771050759,"y":132.28762431123516},{"x":70.00026733602768,"y":132.26759989510361},{"x":73.00017109559134,"y":132.2515801444957},{"x":76.00010950139703,"y":132.2387642325445},{"x":78.00008045008839,"y":132.2314408198502},{"x":80.00005910623186,"y":132.22516359079037},{"x":84.00003324728101,"y":132.21574771918054},{"x":86.0000244265814,"y":132.2117123389404},{"x":88.0000179460639,"y":132.2082534385503},{"x":91.0000114854833,"y":132.20410275481296},{"x":93.00000843831518,"y":132.20173093436466},{"x":94.00000719004404,"y":132.20063624776174},{"x":96.0000052824817,"y":132.19875964176472},{"x":98.00000388100715,"y":132.19715112203284},{"x":99.03467016603408,"y":132.27597272975237},{"x":100.02954725288836,"y":132.34591754464142},{"x":101.02518057690486,"y":132.41051880057285},{"x":102.02145870380289,"y":132.47017969825148},{"x":104.01576874376616,"y":132.57251935224926},{"x":105.01343729096249,"y":132.61977258097627},{"x":106.0114503985568,"y":132.663402247919},{"x":107.0097571861803,"y":132.70368467816223},{"x":108.00831427547968,"y":132.74087545484417}],"brushColor":"#6aa17c","brushRadius":10},{"points":[{"x":101.86820375331354,"y":104.96112331678252},{"x":100.99269819420165,"y":105.54325566376437},{"x":98.74895750341227,"y":109.65424373121209},{"x":96.55524341728521,"y":116.72625031927801},{"x":95.41873684191985,"y":126.27166239732266},{"x":95.2803927069354,"y":132.19077628350567},{"x":95.19793548363504,"y":137.18913254670377},{"x":95.1484553996554,"y":141.18841832704214},{"x":95.0989719495738,"y":147.1879081505579},{"x":95.3648564610008,"y":152.20432042674534},{"x":95.52351710045083,"y":156.1969635630245},{"x":95.66360404729126,"y":161.19221601991012},{"x":95.7308663141033,"y":164.19051841882236},{"x":95.78468438560554,"y":167.1894318560779},{"x":95.8385084144665,"y":171.18858669637947},{"x":95.87080485961442,"y":174.1881954945005},{"x":96.15516836253799,"y":178.2172761297316},{"x":96.89615066637704,"y":186.23837799674553},{"x":97.11632086531144,"y":189.22008126466213},{"x":97.29274938389126,"y":192.2083599404626},{"x":97.39365610819347,"y":194.2028286617918},{"x":97.51482571545243,"y":197.19731209848595},{"x":97.58409468356899,"y":199.19470955041052},{"x":97.6160710214343,"y":200.19364330002992},{"x":97.67089738735731,"y":202.19201370429894},{"x":97.69620485898221,"y":203.19134609500637},{"x":97.71956733383595,"y":204.19077721751694},{"x":97.74113405745669,"y":205.19029247392163},{"x":97.7610428738236,"y":206.18987942374198},{"x":97.77942108557444,"y":207.1895274653377},{"x":97.79638625164094,"y":208.18922756429163}],"brushColor":"#85f50b","brushRadius":10},{"points":[{"x":180.90009057286673,"y":198.90961266728985},{"x":173.8774417790821,"y":197.89816559692858},{"x":166.48594165424606,"y":195.66214304861023},{"x":162.07128833652538,"y":193.81638480840874},{"x":158.54932483027048,"y":191.9069182943232},{"x":156.22107863617316,"y":190.4747530975908},{"x":152.81943034073944,"y":188.08523787435894},{"x":148.09398280100885,"y":184.01689824092216},{"x":144.57860110182907,"y":180.5784238547193},{"x":140.21584474894806,"y":175.933921843313},{"x":138.8117567113542,"y":174.2966414020539},{"x":137.45728634663462,"y":172.58903606302167},{"x":135.6611602860195,"y":170.4236584585756},{"x":132.93031364700954,"y":165.6197279522685},{"x":130.91600471545922,"y":161.13432134857342},{"x":129.74921649815022,"y":157.58677083852288},{"x":128.3380322901429,"y":152.7138845341878},{"x":127.68745066708361,"y":149.8826959757839},{"x":126.90710764957059,"y":145.0349866707226},{"x":126.43375147744322,"y":141.10154031808392},{"x":126.01356835945563,"y":136.1446183476919},{"x":125.71599140757849,"y":131.16612080142258},{"x":125.57295647401756,"y":128.17381389872972},{"x":125.67955746877753,"y":124.18322076134585},{"x":125.74363134710272,"y":121.18476115052147},{"x":126.50721166307224,"y":115.09428726530093},{"x":128.3581522825885,"y":106.89308160186872},{"x":131.33465180941002,"y":97.61401401967103},{"x":132.3076277753353,"y":94.60531009452008},{"x":133.5932437979457,"y":91.34906350049829},{"x":135.05377111290844,"y":88.12069805896249},{"x":138.0279526481521,"y":83.95430888128722},{"x":140.2416602244397,"y":81.3421798921076},{"x":142.66955414366925,"y":78.82484171112513},{"x":145.9138677715961,"y":76.02600758294969},{"x":150.1620743211309,"y":73.05883308296487},{"x":158.14360297446373,"y":69.30009656377533},{"x":164.64677801640747,"y":67.07393160125983},{"x":170.63600283003973,"y":65.04231106166503},{"x":175.31970393101227,"y":63.938987550542386},{"x":178.37361927493401,"y":63.158572405010325},{"x":185.26375751230285,"y":61.68962155379632},{"x":189.1488760915569,"y":61.071873133625104},{"x":192.09544666128326,"y":60.69799985291225},{"x":196.05375561072955,"y":60.32206819619825},{"x":199.00048634622712,"y":60.29553736815676},{"x":205.014706998981,"y":60.593570980903394},{"x":210.05249116930395,"y":61.06632528549746},{"x":225.29809995557324,"y":64.52939252470017},{"x":229.71059430467156,"y":66.1194145723958},{"x":232.9546626639392,"y":67.4970284743833},{"x":236.16633725010217,"y":69.02690396645153},{"x":239.66435529795862,"y":71.0904147461132},{"x":248.98210643814917,"y":79.27058167863723},{"x":251.85359067579824,"y":82.37636981582052},{"x":253.65276226841573,"y":84.69971323407906},{"x":257.62124031389817,"y":91.02327721284297},{"x":259.7495079004141,"y":95.39711850942304},{"x":260.98552528404133,"y":98.8789195075187},{"x":262.26457496898104,"y":102.7837023940427},{"x":263.48175807425906,"y":108.45470589103174},{"x":264.3128026042035,"y":114.30670183878131},{"x":264.9319300556561,"y":121.23512673800766},{"x":264.95449997343326,"y":127.18758626082744},{"x":263.5972129264709,"y":137.2942703769113},{"x":262.3651305401091,"y":143.42288536422703},{"x":261.0237136402088,"y":148.5746986229844},{"x":259.67563340074935,"y":152.76429033269127},{"x":257.9195762577294,"y":157.84567819043852},{"x":256.57833373385296,"y":161.09521167786087},{"x":254.38485342038527,"y":165.4635383420601},{"x":250.87249607228748,"y":171.72261634651545},{"x":243.9645516240036,"y":181.41534462482363},{"x":240.4742183297388,"y":185.79941923983412},{"x":237.74785612074757,"y":189.02394580240863},{"x":235.504323924496,"y":191.82346655088008},{"x":233.14540801165413,"y":194.37544414885602},{"x":231.21121504991538,"y":196.4367316106502},{"x":229.6786959468216,"y":197.900145979408},{"x":227.39219903549034,"y":199.71845740554826},{"x":226.03543806319837,"y":200.60798764119184},{"x":224.5293256097192,"y":201.4313465791371},{"x":222.90430825330122,"y":202.17790305843005},{"x":220.28960160870724,"y":203.11995829564407},{"x":216.76554215174633,"y":203.82698779382937},{"x":214.827366169916,"y":204.15934579414517},{"x":211.99997836740528,"y":204.16471443867118},{"x":209.9708731963866,"y":204.0230805861991},{"x":207.89774787135195,"y":203.75070043172346},{"x":204.67082344433553,"y":202.97889394051583},{"x":202.75740769609712,"y":202.5882007868029},{"x":201.59510764125017,"y":202.27837023147555},{"x":199.49104122788177,"y":201.6452408085514},{"x":198.30186135383184,"y":201.22085219622116},{"x":197.40276683146098,"y":200.92607039352384},{"x":196.2097263253596,"y":200.47026029104362},{"x":195.85498925069697,"y":200.3030848509484},{"x":195.454931188847,"y":200.0776964174783},{"x":195.01974227026741,"y":199.7908904047403},{"x":194.55928148003315,"y":199.44147391679178}],"brushColor":"#fa5a88","brushRadius":10},{"points":[{"x":355.96889397659936,"y":35.60138491238614},{"x":355.96889397659936,"y":35.60138491238614},{"x":357.3188828654423,"y":41.49085044079797},{"x":356.27526668726546,"y":51.25545512594966},{"x":354.07024142661965,"y":59.586913050096626},{"x":351.4730487930557,"y":66.05233792237657},{"x":348.0795346974715,"y":73.31559458939313},{"x":346.4548863290164,"y":76.49899144466312},{"x":344.4309433681048,"y":80.48680590417432},{"x":342.13352211198963,"y":85.34098209213143},{"x":338.23334115106456,"y":93.38878987348144},{"x":335.8341227304468,"y":97.70117500188533},{"x":332.9459503604492,"y":102.76417642682652},{"x":330.79036526828196,"y":106.67694958340078},{"x":327.63943456987965,"y":112.59520196170602},{"x":325.5657112108755,"y":116.5562790580228},{"x":323.8234860696009,"y":119.69526429938958},{"x":321.4093156420857,"y":124.47585660207608},{"x":320.402606167043,"y":126.47247099379435},{"x":319.0376299284674,"y":128.81701183179527},{"x":317.933812457069,"y":130.75726176090245},{"x":317.16960562598337,"y":132.35813355168912},{"x":316.200656757209,"y":134.3730111404331},{"x":315.83464035082915,"y":135.20450165354947},{"x":315.4898455471739,"y":136.0590999819146},{"x":319.73764145274805,"y":139.55803644466735},{"x":327.38522354094493,"y":143.59049001927903},{"x":333.38889078396096,"y":145.15729492885168},{"x":338.1948143061885,"y":146.03399338644437},{"x":344.08681954478783,"y":146.74662129533712},{"x":348.00460283693917,"y":146.85516447612082},{"x":355.00183615076674,"y":146.97758514356428},{"x":361.01154557361826,"y":146.7137703360146},{"x":370.03160348434733,"y":146.0578360524032},{"x":375.0722392887441,"y":145.50223359089182},{"x":378.04627216340623,"y":145.24030140987912},{"x":380.0340105992906,"y":145.090327592683},{"x":384.0191394404861,"y":144.864980814107},{"x":386.0140641478488,"y":144.76831128442583},{"x":388.0103342029117,"y":144.6854097047962},{"x":390.0682013671625,"y":144.4650685443123},{"x":393.0436836508195,"y":144.21048551227227},{"x":395.1241127918063,"y":143.9089247059516},{"x":397.0912909619654,"y":143.66487911432117},{"x":400.1623207463045,"y":143.15456631475078},{"x":403.10408261996014,"y":142.76456996904565},{"x":405.07654342602666,"y":142.54071222599117},{"x":408.049031602968,"y":142.2711763230512},{"x":410.0360397518307,"y":142.11683050107297},{"x":413.09851393120215,"y":141.7219801576465},{"x":414.08398779714264,"y":141.6047696219686},{"x":416.0617538565718,"y":141.40334498145168},{"x":418.0453964115436,"y":141.23031016626487},{"x":419.1464706065289,"y":141.05668188470693}],"brushColor":"#383c7c","brushRadius":10},{"points":[{"x":387.2116587067679,"y":118.46519903604214},{"x":386.2534352371647,"y":119.47654099504952},{"x":382.84299500071114,"y":127.20818310762974},{"x":381.12112965010243,"y":133.600500832517},{"x":379.8883404701735,"y":141.3370075938295},{"x":379.0332003933489,"y":151.23206203448893},{"x":378.45962180200667,"y":166.1963054056687},{"x":378.2903370308391,"y":173.19101283047726},{"x":378.2049562431947,"y":178.18925042190006},{"x":378.14467937674965,"y":183.1883722034498},{"x":378.1085110113798,"y":187.18799062001244},{"x":378.0868093769779,"y":190.18781399860526},{"x":378.0694477923364,"y":193.18770095984354},{"x":378.0490221415022,"y":198.187600132516},{"x":378.04201902136384,"y":200.18757356681536},{"x":378.03601633106297,"y":202.18755404912602},{"x":377.8268462086188,"y":205.21602033592785},{"x":377.4534803701852,"y":208.27585045791363},{"x":377.24696500745745,"y":210.25246425350235},{"x":376.91027436817734,"y":212.34052351490962},{"x":376.4681637733,"y":214.44406917301552},{"x":376.28177175143304,"y":215.40643393302787},{"x":376.1089847397178,"y":216.3742792974296},{"x":375.94891027731825,"y":217.34681806309436},{"x":375.8006924345793,"y":218.32337311446608},{"x":375.66351560813655,"y":219.30336284909643}],"brushColor":"#b38cf4","brushRadius":10}],"width":"400","height":400}';


const RedoIcon = makeIcon(SettingsBackupRestore)`
  transform: rotateY(180deg);
`;
const OneIcon = makeDefaultIcon(InvertColorsOff);
const UndoIcon = makeDefaultIcon(SettingsBackupRestore);
const ClearIcon = makeDefaultIcon(Clear);
const RandomIcon = makeDefaultIcon(Shuffle);
const ToolsHandle = makeDefaultIcon(Palette);
const ShuffleIcon = makeDefaultIcon(InvertColors);

const getRandomColor = () =>
  "#" + (((1 << 24) * Math.random()) | 0).toString(16);

const NotFound = props => {
  const { history, route: thisRoute, location } = props;
  const redirectCount = 10;
  const timeout = 5000;
  const [curCount, setCurCount] = useState(redirectCount);
  const [freezeCount, setFreezeCount] = useState(false);
  const [color, setColor] = useState("#333");

  const [savedDrawing, setSavedDrawing, clearStorage] = useSessionStorageMem(
    "savedDrawing",
    defaultDrawing
  );
  const [manFreezeCount, setManFreezeCount] = useState(false);
  const [userColor, setUserColor] = useState(false);
  const [redoData, setRedoData] = useState(false);

  const canvasRef = useRef();

  // const loadPic = useCallback(
  //   immediate => {
  //     if (savedDrawing) {
  //       if (canvasRef.current) {
  //         try {
  //           const curRef = canvasRef.current;
  //           const { loadSaveData } = curRef;
  //           const data =
  //             typeof savedDrawing === "string"
  //               ? savedDrawing
  //               : JSON.stringify(savedDrawing);
  //           loadSaveData(data, immediate);
  //           return data;
  //         } catch (error) {
  //           console.log("TCL: loadPic -> error", error);
  //         }
  //         // setSavedDrawing(data)
  //       }
  //       return savedDrawing;
  //     }
  //     return "";
  //   },
  //   [savedDrawing]
  // );

  const runWithCanvasRef = useCallback(cb => {
    const curRef = canvasRef.current;
    if(curRef) {
      return cb(curRef);
    }
  }, [canvasRef])

  const savePic = useCallback(() => {
    runWithCanvasRef((ref) => {
      const { getSaveData } = ref;
      const dataToSave = getSaveData();
      if (dataToSave !== savedDrawing) {
        setSavedDrawing(dataToSave);
      }
    })
  }, [setSavedDrawing, savedDrawing, runWithCanvasRef]);

  const clearCanvas = () => {
    runWithCanvasRef(ref => {
      const { clear } = ref;
      clear()
      clearStorage(false);
    })
  };

  const undo = () => {
    runWithCanvasRef(ref => {
      const { undo, getSaveData } = ref;
      const curData = getSaveData();
      setRedoData(curData);
      undo();
      const newData = getSaveData();
      setSavedDrawing(newData);
    })
  };
  
  const redo = () => {
    if (redoData) {
      if (redoData !== savedDrawing) {
        setSavedDrawing(redoData);
      }
    }
  };

  useEffect(() => {
    let timer = null;
    if (!freezeCount && !manFreezeCount) {
      timer = setTimeout(() => {
        const newCount = curCount - 1;
        if (newCount >= 0) {
          setCurCount(newCount);
        } else {
          const redirPath = thisRoute.path;
          if (location.pathname === redirPath) {
            setManFreezeCount(true);
          } else {
            history.push(redirPath);
          }
        }
      }, 1000);
    } else if (curCount >= redirectCount && !manFreezeCount) {
      timer = setTimeout(() => {
        setFreezeCount(false);
      }, timeout);
    }
    return () => clearTimeout(timer);
  });

  useEffect(() => {
    if (typeof savedDrawing !== "string") {
      console.log("Doing supervision for drawing");
      try {
        const stringed = JSON.stringify(savedDrawing);
        setSavedDrawing(stringed);
        // loadPic()
      } catch (error) {
        console.log("Supervision failed for drawing", error);
      }
    }
  });

  const bind = useCallback(() => {
    const handler = e => {
      let write = false;
      if (!freezeCount) {
        setCurCount(10);
        setFreezeCount(true);
        write = true;
      }
      if (!userColor) {
        write = true;
        setColor(getRandomColor());
      }
      if (write) {
        // setSavedDrawing()
        // savePic(true);
        savePic();
      }
    };
    return {
      onMouseUp: handler,
      onTouchEnd: handler
    };
  }, [freezeCount, setFreezeCount, setColor, userColor, savePic]);

  const handleColor = color => {
    if(!userColor) {
      setUserColor(true);
    }
    setColor(color.hex);
  };

  const tryString = string => {
    if (string) {
      try {
        return typeof string === "string" ? string : JSON.stringify(string);
      } catch (error) {
        console.log("Stringify error", error, "Typeof string", typeof string);
        return "";
      }
    }
    // return sadDrawing
    console.log("No string");
    return "";
  };

  return (
    <article>
      <h2>Uuups</h2>
      <p>Ser ud som vi ikke har en {props.location.pathname}</p>
      {!manFreezeCount ? (
        <p>
          Du bliver omdirigeret til{" "}
          <NavLink to={thisRoute.path}>{thisRoute.name}</NavLink> om {curCount}{" "}
          sek.{" "}
          <button onClick={() => setManFreezeCount(true)}>
            NEJ! Jeg vil tegne!
          </button>
        </p>
      ) : (
        <p>
          Tegnemode valgt. tryk <NavLink to={"/"}>her</NavLink> for at komme til
          start side{" "}
        </p>
      )}
      <figure {...bind()} className={styles.drawingBoard}>
        <CanvasDraw
          canvasWidth="400"
          brushColor={color}
          className={styles.canvas}
          ref={canvasRef}
          saveData={tryString(savedDrawing)}
          immediateLoading
        />

        <figcaption className={styles.toolBox}>
          <div className={styles.showIcon}>
            <ToolsHandle style={{ color: color }} />
          </div>
          <section className={styles.tools}>
            <SketchPicker color={color} onChangeComplete={handleColor} />
            <div className={styles.toolButtons}>
              <button
                onClick={() => setUserColor(!userColor)}
                style={{ background: color }}
              >
                {userColor ? <ShuffleIcon /> : <OneIcon />}
              </button>
              <button
                onClick={() => {
                  setUserColor(true);
                  setColor(getRandomColor());
                }}
                style={{ background: color }}
              >
                <RandomIcon />
              </button>
              <button onClick={clearCanvas}>
                <ClearIcon />
              </button>
              <button onClick={undo}>
                <UndoIcon />
              </button>
              <button onClick={redo}>
                <RedoIcon />
              </button>
            </div>
          </section>
        </figcaption>
      </figure>
    </article>
  );
};

export default NotFound;
